pipeline {
    agent any
    
    environment {
        GITHUB_REPO = 'https://github.com/nova-mk3/frontend'
        GITHUB_CREDENTIALS_ID = 'frontend_github_token'  // GitHub ìê²© ì¦ëª… ID
    }
    
    
    stages {
        stage('GitHub Clone') {
        steps {
            script {
                echo "ğŸ”„ Cloning repository..."
                sh 'rm -rf frontend || true'  // ê¸°ì¡´ í´ë” ì‚­ì œ
          
                 
                checkout([
                $class: 'GitSCM',
                branches: [[name: '*/main']],
                userRemoteConfigs: [[
                    url: env.GITHUB_REPO,
                    credentialsId: env.GITHUB_CREDENTIALS_ID
                ]],
                extensions: [[$class: 'RelativeTargetDirectory', relativeTargetDir: 'frontend']]
])
            
          
                echo "âœ… Git Clone ì™„ë£Œ!"
            }
        }
}

        stage('Inject .env.production') {
            steps {
                withCredentials([string(credentialsId: 'env_production_text_frontend', variable: 'ENV_PROD')]) {
                    script {
                        // service ê²½ë¡œì— íŒŒì¼ ìƒì„±
                        dir('frontend/apps/service') {
                            writeFile file: '.env.production', text: ENV_PROD + ''
                            echo "âœ… service .env.production ìƒì„± ì™„ë£Œ at frontend/apps/service/"
                        }

                        // admin ê²½ë¡œì— íŒŒì¼ ìƒì„±
                        dir('frontend/apps/admin') {
                            writeFile file: '.env.production', text: ENV_PROD + ''
                            echo "âœ… admin .env.production ìƒì„± ì™„ë£Œ at frontend/apps/admin/"
                        }
                    }
                }
            }
}

        stage('Cleanup') {
            steps {
                script {
                    def composeFile = "frontend/docker-compose.yml"
                    if (fileExists(composeFile)) {  
                        echo "ğŸ§¹ Cleaning up old Docker containers..."
                        
                        dir('frontend') {
                            sh '''
                            docker compose down --rmi all --volumes --remove-orphans || true
                            docker rmi frontend_admin_image:latest frontend_service_image:latest || true
                            '''
                        }
                    
                        echo "âœ… Cleanup ì™„ë£Œ!"
                    } else {
                        echo "âš ï¸ frontend/docker-compose.yml not found. Skipping cleanup."
                    }
                }
            }
        }

        stage('Deploy') {
            steps {
                script {
                    def composeFile = "frontend/docker-compose.yml"
                    if (fileExists(composeFile)) {  
                        echo "ğŸš€ Deploying Docker containers..."
                        dir('frontend') {
                            sh '''
                            docker compose up -d --build || (echo "âŒ Deployment Failed!" && exit 1)
                            '''
                        }
                        echo "âœ… Deployment ì™„ë£Œ!"
                    } else {
                        error "âŒ docker-compose.yml not found! Stopping pipeline."
                    }
                }
            }
        }
    }
    
    post {
        success {
            echo "ğŸ‰ Deployment ì„±ê³µ! ğŸš€"
        }
        failure {
            echo "âŒ Deployment ì‹¤íŒ¨. Logs í™•ì¸ ìš”ë§."
        }
    }
}
