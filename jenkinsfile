pipeline {
    agent any
    
    environment {
        GITHUB_REPO = 'https://github.com/nova-mk3/frontend'
        GITHUB_CREDENTIALS_ID = 'github_access_token_frontend'  // GitHub ìê²© ì¦ëª… ID
    }
    
    stages {
        stage('GitHub Clone') {
            steps {
                script {
                    echo "ğŸ”„ Cloning repository..."
                    sh 'rm -rf frontend || true'  // ê¸°ì¡´ í´ë” ì‚­ì œ (ì—ëŸ¬ ë°©ì§€)
                    
                    // âœ… frontend ë””ë ‰í† ë¦¬ì—ì„œ Git Clone ì‹¤í–‰
                    dir('frontend') {  
                        git branch: 'main', credentialsId: env.GITHUB_CREDENTIALS_ID, url: env.GITHUB_REPO
                    }
                    echo "âœ… Git Clone ì™„ë£Œ!"
                }
            }
        }

        stage('Cleanup') {
            steps {
                script {
                    def composeFile = "frontend/docker-compose.yml"
                    if (fileExists(composeFile)) {  
                        echo "ğŸ§¹ Cleaning up old Docker containers..."
                        dir('frontend') {
                            sh '''
                            docker-compose down --rmi all --volumes --remove-orphans || true
                            '''
                        }
                        echo "âœ… Cleanup ì™„ë£Œ!"
                    } else {
                        echo "âš ï¸ frontend/docker-compose.yml not found. Skipping cleanup."
                    }
                }
            }
        }

        stage('Deploy') {
            steps {
                script {
                    def composeFile = "frontend/docker-compose.yml"
                    if (fileExists(composeFile)) {  
                        echo "ğŸš€ Deploying Docker containers..."
                        dir('frontend') 
                            sh '''
                            docker-compose up -d --build || (echo "âŒ Deployment Failed!" && exit 1)
                            '''
                        }
                        echo "âœ… Deployment ì™„ë£Œ!"
                    } else {
                        error "âŒ docker-compose.yml not found! Stopping pipeline."
                    }
                }
            }
        }
    }
    
    post {
        success {
            echo "ğŸ‰ Deployment ì„±ê³µ! ğŸš€"
        }
        failure {
            echo "âŒ Deployment ì‹¤íŒ¨. Logs í™•ì¸ ìš”ë§."
        }
    }
}
